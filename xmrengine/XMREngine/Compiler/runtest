#!/bin/bash -v

function testit {
    mono --debug xmrengtest.exe $1.lsl 2>&1 | tee $1.out
    diff $1.out $1.good
    mono --debug xmrengtest.exe -serialize $1.lsl 2>&1 | tee $1.ser
    diff $1.ser $1.good
}

function testev {
    mono --debug xmrengtest.exe -eventio $1.lsl < $1.events 2>&1 | tee $1.out
    diff $1.out $1.good
    mono --debug xmrengtest.exe -eventio -serialize $1.lsl < $1.events 2>&1 | tee $1.ser
    diff $1.ser $1.good
}

set -e
time make xmrengtest.exe
export MONO_PATH=../../../bin
export PATH=~/mono64.267/bin:$PATH

testit arraytest
testit chartest
testit objectest
testit proptest
testit trycatchexample
testit trycatchtest
testit while1
testev testllparcelmedia
testit typeassigntest
testit partialtest
testev statechange

mono --debug xmrengtest.exe -eventio -ipcchannel -9 \
	-primname zero -primuuid 0000 ipctest0.lsl \
	-primname one -primuuid 1111 ipctest1.lsl << EOF | tee ipctest.out
touch_start(0)
EOF
diff ipctest.out ipctest.good
mono --debug xmrengtest.exe -eventio -ipcchannel -9 -serialize \
	-primname zero -primuuid 0000 ipctest0.lsl \
	-primname one -primuuid 1111 ipctest1.lsl << EOF | tee ipctest.ser
touch_start(0)
EOF
diff ipctest.ser ipctest.good

echo "SUCCESS"
